from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import pandas as pd
import time

# Login credentials
username = 'username'
password = 'password'

# Set up Chrome options for headless mode
chrome_options = webdriver.ChromeOptions()
user_agent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36'
chrome_options.add_argument(f'user-agent={user_agent}')

# Initialize the WebDriver with the specified options
driver = webdriver.Chrome(options=chrome_options)
driver.set_window_size(1080, 800)  # Set the size of the window

# Navigate to your Depop shop
login_url = 'https://www.depop.com/login/'
driver.get(login_url)

# Bypass cookie banner to interact with website
try:
    # Locate the "Accept" button using its data-testid attribute
    cookie_button = WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.XPATH, "//button[@data-testid='cookieBanner__acceptAllButton']"))
    )
    cookie_button.click()  # Click the accept button
    print("Cookie banner accepted.")

except Exception as e:
    print("No cookie banner found or unable to click the button:", e)

# Step 1: Find the username and password fields and the login button
WebDriverWait(driver, 10).until(
    EC.presence_of_element_located((By.ID, 'username__input'))
)

time.sleep(2.2)

# Step 2: Enter your credentials
username_input = driver.find_element(By.ID, 'username__input')
username_input.send_keys(username)

time.sleep(1.7)

password_input = driver.find_element(By.ID, 'password__input')
password_input.send_keys(password)

# Step 3: Click the login button
login_button = driver.find_element(By.XPATH, "//button[@data-testid='login__cta']")  # Use the data-testid to locate the button

time.sleep(1.2)

login_button.click()

# Step 4: Prompt for 2FA code
two_fa_code = input("Please enter your 2FA code: ")  # Wait for user input

time.sleep(26.4)

# Step 5: Find the 2FA input field and enter the code
try:
    # Loop through the six inputs and enter each digit of the 2FA code
    for i in range(6):
        input_field = WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.XPATH, f"//input[@data-testid='verification-code__input-{i}']"))
        )
        input_field.send_keys(two_fa_code[i])  # Enter the corresponding digit
    
    # Optionally click the submit button for the 2FA
    submit_button = driver.find_element(By.XPATH, "//button[@data-testid='mfa__otp-submit']")
    submit_button.click()
    
except Exception as e:
    print("Error while entering 2FA code:", e)

# Wait for a few seconds after entering the 2FA code
time.sleep(3)  # Adjust if needed to ensure the next page loads completely

# Now navigate to your shop's private page
hub_url = "https://www.depop.com/sellinghub/sold-items/"  
driver.get(hub_url)

# Step 4: Data scraping logic (similar to previous examples)
item_data = []
previous_height = driver.execute_script("return document.body.scrollHeight")  # Get initial height

while True:
    # Wait for item containers to load
    item_containers = WebDriverWait(driver, 10).until(
        EC.presence_of_all_elements_located((By.CLASS_NAME, "ReceiptsList-styles__ReceiptListWrapper-sc-55d3004f-1 erxsdC"))
    )
    # Extract data from the current batch of items
    for item in item_containers:
        
        try:
            # Get the sold date (contained within the span with 'Sold on')
            date_element = item.find_element(By.XPATH, ".//p[contains(text(), 'Sold on')]")

            date = date_element.find_elements(By.TAG_NAME, 'span')[-1].text.strip()
            location = item.find_elements(By.CLASS_NAME, "index-styles__LocationDetails-sc-971ea662-3 iUKcNd")[-1].text


            item_image = item.find_element(By.CLASS_NAME, "ImageStack-styles__Container-sc-81f7be5e-0 kEAKhX")
            item_image.click()

            item_receipts = WebDriverWait(driver, 10).until(
                EC.presence_of_all_elements_located((By.CLASS_NAME, "styles__ProductLink-sc-233ee08-7 eGrPtP"))
            )
            for item_receipt in item_receipts:
                try:
                    # Extract item image
                    img_link = item_receipt.find_element(By.TAG_NAME, 'img').get_attribute('src')

                    # Extract secondary information
                    info_tag = item_receipt.find_element(By.CLASS_NAME, "styles__ProductInformation-sc-233ee08-2 iEDEu").find_elements(By.TAG_NAME, 'p')

                    description = info_tag[0].text
                    size = info_tag[1].text
                    price_listed = info_tag[2].text
                    price_sold = info_tag[3].text
                    brand = info_tag[4].text
                    # Collect data
                    item_data.append({
                        'Image': img_link,
                        'Description': description,
                        'Price listed': price_listed,
                        'Price sold': price_sold,
                        'Size': size,
                        'Brand': brand,
                        'Date': date,
                        'Location': location
                    })
                except Exception as e:
                    print(f"Error extracting receipt data: {e}")

        except Exception as e:
            print(f"Error extracting item data: {e}")

    # Scroll down to load more items
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(2)  # Wait for items to load

    # Get the new height of the page after scrolling
    new_height = driver.execute_script("return document.body.scrollHeight")
    
    # If the height hasn't changed, we've reached the end of the list
    if new_height == previous_height:
        break  # Exit the loop if no new items are loaded
    
    previous_height = new_height  # Update the height for the next iteration

# Define the path to save the CSV file on the desktop
desktop_path = r'C:\Users\legat\OneDrive\Desktop\depop_item_details_complete.csv'  # Use your desktop path

# Save the data to a CSV file
df = pd.DataFrame(item_data)
df.to_csv(desktop_path, index=False)

# Close the driver
driver.quit()
